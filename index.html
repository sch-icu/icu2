<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SCH ICU ì•½ë¬¼ ê³„ì‚°ê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f0f2f5; --bg-header: #0055b8; --text-main: #333;
            --bg-card: #ffffff; --border-color: #e0e0e0;
            --bg-input-yellow: #fffde7; --text-input: #000;
            --bg-th: #546e7a; --text-th: #fff;
            --bg-red: #ffebee; --text-red: #c62828;
            --bg-blue: #e3f2fd; --text-blue: #1565c0;
            --bg-green: #e8f5e9; --text-green: #2e7d32;
            --bg-yellow: #fffde7; --text-yellow: #f57f17;
            
            --u-std: #1565c0; --u-vaso: #d32f2f; --u-mcgmin: #2e7d32;
            --u-mghr: #ef6c00; --u-mcghr: #8e24aa;
        }
        body.dark-mode {
            --bg-body: #121212; --bg-header: #1a237e; --text-main: #e0e0e0;
            --bg-card: #1e1e1e; --border-color: #333;
            --bg-input-yellow: #2c2c2c; --text-input: #fff000; --bg-th: #37474f;
            --bg-red: #3e2723; --text-red: #ffcdd2;
            --bg-blue: #0d47a1; --text-blue: #bbdefb;
            --bg-green: #1b5e20; --text-green: #c8e6c9;
            --bg-yellow: #4a4419; --text-yellow: #fff59d;
            --u-std: #90caf9; --u-vaso: #ef9a9a; --u-mcgmin: #a5d6a7;
            --u-mghr: #ffcc80; --u-mcghr: #ce93d8;
        }
        body { margin:0; padding:0; font-family:'Noto Sans KR',sans-serif; background:var(--bg-body); color:var(--text-main); -webkit-text-size-adjust:100%; transition:0.3s; }
        
        /* Header */
        .header { background:var(--bg-header); padding:20px 10px 15px 10px; position:sticky; top:0; z-index:1000; box-shadow:0 2px 8px rgba(0,0,0,0.3); display:flex; flex-direction:column; align-items:center; }
        .btn-darkmode { position:absolute; top:15px; right:15px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.3); color:#fff; border-radius:50%; width:40px; height:40px; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .hospital-title { margin:0; font-size:2.3rem; font-weight:900; color:white; text-align:center; margin-bottom:5px; margin-top:15px; text-shadow:0 2px 4px rgba(0,0,0,0.3); line-height:1.1; }
        .dept-title { margin:0 0 10px 0; font-size:1.5rem; font-weight:500; color:#bbdefb; opacity:0.95; }

        /* Dept Selector Colors (Bright/Pastel) */
        .dept-switch-row { display:flex; width:100%; max-width:600px; gap:6px; margin-bottom:12px; }
        .dept-btn {
            flex: 1; padding: 10px 0;
            border: 1px solid rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.25);
            color: #ccc;
            border-radius: 8px;
            font-size: 1rem; font-weight: 800; cursor: pointer;
            transition: 0.2s; white-space: nowrap;
        }
        #btn-sicu.active {
            background: #4db6ac; /* Bright Teal */
            color: white; border-color: #80cbc4;
            box-shadow: 0 0 10px rgba(77,182,172, 0.6);
            transform: scale(1.02);
        }
        #btn-ccu.active {
            background: #f06292; /* Bright Pink */
            color: white; border-color: #f48fb1;
            box-shadow: 0 0 10px rgba(240,98,146, 0.6);
            transform: scale(1.02);
        }
        #btn-micu.active {
            background: #7986cb; /* Bright Indigo */
            color: white; border-color: #9fa8da;
            box-shadow: 0 0 10px rgba(121,134,203, 0.6);
            transform: scale(1.02);
        }

        .control-top-row { display:flex; width:100%; max-width:600px; gap:8px; margin-bottom:8px; justify-content: space-between; }
        .weight-container { flex:0 0 auto; background: #d32f2f; border:1px solid rgba(255,255,255,0.3); border-radius:8px; padding:5px 15px; display:flex; align-items:center; gap:8px; }
        .weight-label { font-size:1rem; font-weight:700; color:white; white-space:nowrap; }
        .weight-input { width:70px; height:42px; border:2px solid #ffcdd2; border-radius:6px; text-align:center; font-size:1.7rem; font-weight:900; background:#fff; color:#d32f2f; }
        
        .btn-group { display:flex; gap:4px; flex:1; }
        .btn-common {
            flex:1; border-radius:8px; font-weight:800; cursor:pointer; 
            box-shadow:0 2px 4px rgba(0,0,0,0.2); padding:12px 0; 
            font-size: 0.8rem; letter-spacing: -0.5px; white-space: nowrap; 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-vent { background:#009688; color:#fff; border:2px solid #00796b; }
        .btn-yale { background:#7e57c2; color:#fff; border:2px solid #5e35b1; }
        .btn-heparin { background:#ff9800; color:#fff; border:2px solid #f57c00; }
        .btn-setting { background:#fdd835; color:#000; border:2px solid #fbc02d; }

        .mode-row { display:flex; gap:5px; width:100%; max-width:600px; }
        .mode-btn { flex:1; border:none; border-radius:6px; padding:12px 0; font-size:1rem; font-weight:700; cursor:pointer; background:rgba(0,0,0,0.25); color:#cfd8dc; transition:0.2s; white-space:nowrap; }
        .mode-btn.active { background:#fff; color:var(--sch-blue); box-shadow:0 1px 3px rgba(0,0,0,0.2); }

        .table-wrap { padding:10px 5px 200px 5px; max-width:800px; margin:0 auto; }
        table { width:100%; border-collapse:separate; border-spacing:0; background:var(--bg-card); border-radius:8px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        th { background:var(--bg-th); color:var(--text-th); padding:10px 2px; font-size:0.8rem; font-weight:700; text-align:center; border-bottom:1px solid var(--border-color); }
        td { text-align:center; vertical-align:middle; height:65px; border-bottom:1px solid var(--border-color); border-right:1px solid var(--border-color); padding:0; }
        td:last-child { border-right:none; } tr:last-child td { border-bottom:none; }

        .td-name { width:26%; padding:0 4px; font-weight:700; cursor:pointer; }
        .drug-cell-container { display:flex; align-items:center; }
        .copy-btn-area { padding-right:4px; display:flex; align-items:center; }
        .copy-icon { font-size:0.9rem; color:var(--sch-blue); font-weight:900; cursor:pointer; padding:4px; }
        .name-area { flex:1; text-align:center; }
        .drug-title-row { display:flex; align-items:center; justify-content:center; gap:3px; }
        .drug-title { font-size:0.95rem; line-height:1.1; margin-bottom:2px; word-break:break-all; }
        .drug-mix-info { font-size:0.65rem; font-weight:500; opacity:0.8; display:block; color:inherit; line-height:1.2; }
        .info-icon { font-size:0.8rem; opacity:0.6; border:1px solid currentColor; border-radius:50%; width:14px; height:14px; display:inline-flex; align-items:center; justify-content:center; }

        .td-white { width:12%; background:var(--bg-card); color:var(--text-main); }
        .input-mini { width:100%; border:none; text-align:center; font-size:1.3rem; font-weight:700; color:var(--text-main); background:transparent; padding:0; }
        .td-input { width:18%; background:var(--bg-input-yellow); }
        .input-dose { width:100%; height:100%; border:none; background:transparent; text-align:center; font-size:1.6rem; font-weight:900; color:var(--text-input); }
        .td-unit { width:13%; background:var(--bg-input-yellow); font-size:0.8rem; font-weight:800; padding:0 1px; white-space:normal; line-height:1.1; }
        .td-result { width:19%; font-weight:900; }
        .res-val { font-size:1.5rem; display:block; line-height:1; }
        .res-unit { font-size:0.75rem; font-weight:500; margin-top:3px; opacity:0.8; }

        .txt-standard { color: var(--u-std) !important; }
        .txt-vaso { color: var(--u-vaso) !important; }
        .txt-mcgmin { color: var(--u-mcgmin) !important; }
        .txt-mghr { color: var(--u-mghr) !important; }
        .txt-mcghr { color: var(--u-mcghr) !important; }

        .theme-red .td-name, .theme-red .td-result { background:var(--bg-red); color:var(--text-red); }
        .theme-blue .td-name, .theme-blue .td-result { background:var(--bg-blue); color:var(--text-blue); }
        .theme-green .td-name, .theme-green .td-result { background:var(--bg-green); color:var(--text-green); }
        .theme-yellow .td-name, .theme-yellow .td-result { background:var(--bg-yellow); color:var(--text-yellow); } 

        .footer-bar { position:fixed; bottom:0; left:0; width:100%; background:var(--bg-card); border-top:1px solid var(--border-color); padding:10px; display:flex; flex-direction:column; align-items:center; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:2000; }
        .btn-copy { width:95%; max-width:600px; padding:12px; background:#2196f3; color:white; border:none; border-radius:8px; font-size:1.1rem; font-weight:800; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
        .footer-disclaimer { width:95%; max-width:600px; font-size:0.65rem; color:var(--text-main); opacity:0.7; margin-top:6px; margin-bottom:2px; text-align:center; line-height:1.2; word-break:keep-all; }
        .copyright-text { font-size: 0.65rem; color: #999; margin-top: 0; text-align: center; line-height: 1.2; font-weight: 500; }

        .popup-panel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:85%; max-width:350px; background:var(--bg-card); color:var(--text-main); z-index:3000; padding:20px; border-radius:12px; box-shadow:0 5px 25px rgba(0,0,0,0.5); max-height:80vh; overflow-y:auto; border:1px solid var(--border-color); }
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2500; }
        .check-item { display:flex; align-items:center; margin:10px 0; font-size:1rem; font-weight:500; }
        .bulk-btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-bulk { flex: 1; padding: 10px; background: #e0e0e0; border: 1px solid #ccc; border-radius: 6px; font-weight: 700; cursor: pointer; color: #333; font-size: 0.9rem; }
        .btn-bulk:active { background: #d5d5d5; }
        
        .btn-confirm-final { width:100%; padding:15px; border:none; border-radius:8px; font-size:1.2rem; font-weight:900; cursor:pointer; margin-top:20px; margin-bottom:10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-reset-final { width:100%; padding:10px; background:#e53935; color:white; border:none; border-radius:8px; font-size:0.9rem; font-weight:700; cursor:pointer; margin-top:10px; opacity:0.9; }
        .btn-popup-close { width:100%; padding:10px; background:#555; color:white; border:none; border-radius:8px; margin-top:15px; font-size:1rem; font-weight:700; cursor:pointer; }
        
        .vent-row { display:flex; align-items:center; gap:5px; margin-bottom:5px; }
        .vent-row { justify-content: space-between; margin-bottom: 15px; }
        .free-input { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:1.1rem; text-align:center; font-weight:700; background:#fff; color:#333; }
        
        .vent-label { font-weight:700; color:var(--sch-blue); }
        .gender-btn { flex:1; padding:12px; border:1px solid #ccc; background:#f0f0f0; color:#666; cursor:pointer; font-weight:700; border-radius:6px; transition:0.2s; }
        .gender-btn.active { background:#0055b8; color:#fff; border-color:#004ba0; box-shadow:0 2px 4px rgba(0,0,0,0.3); }
        .vent-section-header { font-size:0.9rem; font-weight:900; color:#455a64; margin-top:15px; margin-bottom:5px; text-align:left; border-left:4px solid #009688; padding-left:8px; }
        .vt-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:5px; }
        .vt-item { background:#fff; padding:10px 5px; border-radius:6px; text-align:center; border:1px solid #b2dfdb; }
        .vt-label { display:block; font-size:0.75rem; color:#00796b; margin-bottom:2px; }
        .vt-val { font-size:1.2rem; font-weight:900; color:#004d40; }
        .pbw-display { text-align:center; font-size:2rem; font-weight:900; color:#d32f2f; margin:10px 0; background:#ffebee; padding:10px; border-radius:8px; }
        .btn-vent-print { width:100%; padding:12px; background:#607d8b; color:white; border:none; border-radius:8px; font-size:1rem; font-weight:800; cursor:pointer; margin-top:15px; box-shadow:0 4px 6px rgba(0,0,0,0.2); }

        .hep-protocol-box { border: 2px solid #ffcc80; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .hep-protocol-title { background: #ffe0b2; color: #e65100; padding: 10px; font-weight: 900; text-align: center; border-bottom: 1px solid #ffcc80; }
        .hep-calc-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fff; border-bottom: 1px solid #eee; }
        .hep-calc-row:last-child { border-bottom: none; }
        .hep-calc-label { font-size: 0.9rem; font-weight: 700; color: #555; }
        .hep-calc-input { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: 700; font-size: 1rem; color: #e65100; }
        .hep-calc-result { width: 80px; padding: 5px; background: #e3f2fd; border-radius: 4px; text-align: center; font-weight: 900; font-size: 1rem; color: #1565c0; }
        .hep-section-header { background:#fff3e0; color:#e65100; padding:8px; font-weight:900; border-left:5px solid #ff9800; margin-top:20px; margin-bottom:10px; font-size:0.95rem; text-align:left; }
        .hep-input-row { display:flex; align-items:center; gap:5px; margin-bottom:10px; }
        .hep-input { width:80px; padding:10px; border:2px solid #ff9800; border-radius:6px; text-align:center; font-size:1.2rem; font-weight:700; color:#e65100; }
        .hep-select { flex:1; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:1rem; background:white; color:#333; }
        .hep-action-box { background:#fbe9e7; padding:15px; border-radius:8px; text-align:center; margin-top:15px; border:2px solid #ff5722; }
        .hep-action-text { font-size:1.1rem; font-weight:900; color:#bf360c; display:block; margin-bottom:5px; }
        .hep-new-rate { font-size:2rem; font-weight:900; color:#d84315; }

        .info-title { font-size:1.3rem; font-weight:900; margin-bottom:10px; color:var(--sch-blue); border-bottom:2px solid #ddd; padding-bottom:5px; }
        .info-content { font-size:1rem; line-height:1.6; white-space:pre-line; text-align:left; }
        .empty-msg { text-align:center; padding:40px; color:#999; display:none; }

       @media print {
            body {
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* í™”ë©´ UI ì „ë¶€ ìˆ¨ê¹€ */
            .header, .footer-bar, .overlay, .table-wrap { display: none !important; }

            /* vent-panel ì´ì™¸ì˜ íŒì—…ì€ ìˆ¨ê¹€ */
            .popup-panel { display: none !important; }
            #vent-panel { display: block !important; }

            /* â”€â”€ vent-panel ì¹´ë“œ ë³¸ì²´ â”€â”€ */
            #vent-panel {
                position: static !important;
                width: 100mm !important;
                max-width: 100mm !important;
                max-height: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                border: 1px solid #999 !important;
                border-radius: 4px !important;
                transform: none !important;
                left: auto !important;
                top: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                background: #fff !important;
            }

            /* â”€â”€ ë²„íŠ¼ ìˆ¨ê¹€ â”€â”€ */
            #vent-panel .btn-popup-close,
            #vent-panel .btn-vent-print { display: none !important; }

            /* â”€â”€ íƒ€ì´í‹€ â”€â”€ */
            #vent-panel > h3 {
                font-size: 8px !important;
                margin: 5px 0 3px !important;
                padding: 0 !important;
                color: #00796b !important;
            }

            /* â”€â”€ ì„±ë³„ / ì‹ ì¥ í–‰ â”€â”€ */
            #vent-panel .vent-row {
                margin-bottom: 2px !important;
                padding: 0 6px !important;
                gap: 4px !important;
            }
            #vent-panel .vent-label {
                font-size: 5.5px !important;
                width: 30px !important;
                flex-shrink: 0 !important;
                white-space: nowrap !important;
                color: #555 !important;
            }

            /* ì„±ë³„ ë²„íŠ¼ ê°ì‹¸ëŠ” div (inline gap:10px ë®ì–´ì“°ê¸°) */
            #vent-panel .vent-row > div {
                gap: 3px !important;
            }

            /* ì„±ë³„ ë²„íŠ¼ */
            #vent-panel .gender-btn {
                padding: 2px 0 !important;
                font-size: 5.5px !important;
                border: 1px solid #aaa !important;
                background: #fff !important;
                color: #444 !important;
                box-shadow: none !important;
                border-radius: 2px !important;
            }
            #vent-panel .gender-btn.active {
                background: #ddd !important;
                color: #000 !important;
                font-weight: 900 !important;
                border: 1.5px solid #000 !important;
            }

            /* ì‹ ì¥ ì…ë ¥ */
            #vent-panel .free-input {
                padding: 2px !important;
                font-size: 7px !important;
                height: auto !important;
                border: 1px solid #ccc !important;
                border-radius: 2px !important;
            }

            /* â”€â”€ hr êµ¬ë¶„ì„  â”€â”€ */
            #vent-panel hr {
                margin: 4px 6px !important;
                border: none !important;
                border-top: 1px dashed #b2dfdb !important;
            }

            /* â”€â”€ PBW ì„¹ì…˜ â”€â”€ */
            #vent-panel .pbw-label {
                font-size: 5.5px !important;
                color: #666 !important;
                margin-bottom: 1px !important;
            }
            #vent-panel .pbw-display {
                font-size: 10px !important;
                padding: 2px 0 !important;
                margin: 1px 6px !important;
                background: #ffebee !important;
                color: #d32f2f !important;
                border-radius: 3px !important;
                border: 1px solid #ffcdd2 !important;
            }

            /* â”€â”€ ì„¹ì…˜ í—¤ë” (Without/With ARDS) â”€â”€ */
            #vent-panel .vent-section-header {
                font-size: 5.5px !important;
                padding: 1.5px 4px !important;
                margin-top: 4px !important;
                margin-bottom: 2px !important;
                border-left-width: 2.5px !important;
            }

            /* â”€â”€ VT grid + ë°•ìŠ¤ â”€â”€ */
            #vent-panel .vt-grid {
                gap: 3px !important;
                padding: 0 6px !important;
            }
            #vent-panel .vt-item {
                padding: 2px 1px !important;
                border: 1px solid #ccc !important;
                background: #fff !important;
                border-radius: 2px !important;
            }
            #vent-panel .vt-label {
                font-size: 5px !important;
                margin-bottom: 0 !important;
                color: #666 !important;
            }
            /* â”€â”€ Target ê°’ ê¸€ì”¨ í¬ê²Œ â”€â”€ */
            #vent-panel .vt-val {
                font-size: 14px !important;
                color: #000 !important;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <button class="btn-darkmode" onclick="toggleDarkMode()">ğŸŒ™</button>
    <h1 class="hospital-title">ìˆœì²œí–¥ëŒ€í•™êµ ì²œì•ˆë³‘ì›</h1>
    <h3 class="dept-title">ì¤‘í™˜ìì‹¤ ì•½ë¬¼ê³„ì‚°ê¸°</h3>
    
    <div class="dept-switch-row">
        <button class="dept-btn" id="btn-sicu" onclick="setDept('SICU')">SICU</button>
        <button class="dept-btn" id="btn-ccu" onclick="setDept('CCU')">CCU</button>
        <button class="dept-btn" id="btn-micu" onclick="setDept('MICU')">MICU/EICU</button>
    </div>

    <div class="control-top-row">
        <div class="weight-container">
            <span class="weight-label">ì²´ì¤‘(kg)</span>
            <input type="number" id="bw" class="weight-input" value="60" oninput="saveWeight(); calcAll(); calcPBW(); calcHeparin();" step="0.5">
        </div>
        <div class="btn-group">
            <button class="btn-common btn-vent" onclick="openVentCalc()">ğŸŒ¬ï¸ Ventilator</button>
            <button class="btn-common btn-yale" onclick="openYaleScale()">ğŸ’‰ Yale<br>Scale</button>
            <button class="btn-common btn-heparin" onclick="openHeparinCalc()">ğŸ©¸ Heparin</button>
            <button class="btn-common btn-setting" onclick="openSettings()">âš™ï¸ ì•½ë¬¼ì„ íƒ</button>
        </div>
    </div>
    <div class="mode-row">
        <button class="mode-btn active" id="btnMode0" onclick="setMode(0)">ì•½ë¬¼ìš©ëŸ‰ âœ cc/hr</button>
        <button class="mode-btn" id="btnMode1" onclick="setMode(1)">cc/hr âœ ì•½ë¬¼ìš©ëŸ‰</button>
    </div>
</div>

<div class="table-wrap">
    <table id="mainTable">
        <thead>
            <tr>
                <th style="width:26%">ì•½ë¬¼ëª…</th>
                <th style="width:12%">ì•½ë¬¼<br>ìš©ëŸ‰</th>
                <th style="width:12%">ì´<br>ìˆ˜ì•¡ëŸ‰</th>
                <th id="th-input" style="width:18%">ì²˜ë°©</th>
                <th style="width:13%">ë‹¨ìœ„</th>
                <th id="th-output" style="width:19%">ì†ë„</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <div id="empty-msg" class="empty-msg">ì„ íƒëœ ì•½ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<div class="footer-bar">
    <button class="btn-copy" onclick="copyEMR()">ğŸ“‹ EMR ê¸°ë¡ ë³µì‚¬ (Copy Text)</button>
    <div class="footer-disclaimer">
        ë³¸ í”„ë¡œê·¸ë¨ì€ ê³„ì‚° í¸ì˜ë¥¼ ë•ëŠ” ë³´ì¡° ë„êµ¬ì´ë©°, ìµœì¢… íˆ¬ì•½ ìš©ëŸ‰ê³¼ ì†ë„ì˜ í™•ì¸ ì±…ì„ì€ ì‚¬ìš©ì(ì˜ë£Œì¸)ì—ê²Œ ìˆìŠµë‹ˆë‹¤.<br>
        ë°˜ë“œì‹œ EMR ì²˜ë°©ê³¼ ì´ì¤‘ í™•ì¸(Double Check) í•˜ì‹­ì‹œì˜¤. ê°œë°œìëŠ” ì‚¬ìš© ê²°ê³¼ì— ëŒ€í•´ ë²•ì  ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </div>
    <div class="copyright-text">
        Version 1.0 | Copyright Â© 2026 SCH Cheonan Hospital CCU. All rights reserved.
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeAllPopups()"></div>

<div id="vent-panel" class="popup-panel">
    <h3 style="text-align:center; margin-top:0; color:#00796b; margin-bottom:15px;">ğŸŒ¬ï¸ Ventilator Settings</h3>
    <div class="vent-row">
        <span class="vent-label">ì„±ë³„ (Gender)</span>
        <div style="display:flex; gap:10px; flex:1;">
            <button class="gender-btn active" id="btn-male" onclick="setGender('male')">ë‚¨ì„± (Male)</button>
            <button class="gender-btn" id="btn-female" onclick="setGender('female')">ì—¬ì„± (Female)</button>
        </div>
    </div>
    <div class="vent-row">
        <span class="vent-label">ì‹ ì¥ (Height)</span>
        <input type="number" id="vent-height" class="free-input" placeholder="cm" oninput="calcPBW()">
    </div>
    <hr style="border:1px dashed #b2dfdb; margin:15px 0;">
    <div style="text-align:center;">
        <span style="font-size:0.9rem; color:#555;">ì˜ˆì¸¡ ì²´ì¤‘ (PBW)</span>
        <div class="pbw-display"><span id="pbw-val">0.0</span> kg</div>
    </div>
    <div class="vent-section-header">Without ARDS (6 ~ 8 ml/kg)</div>
    <div class="vt-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="vt-item"><span class="vt-label">Target 6ml</span><span id="vt-6" class="vt-val">0</span></div>
        <div class="vt-item"><span class="vt-label">Target 8ml</span><span id="vt-8" class="vt-val">0</span></div>
    </div>
    <div class="vent-section-header" style="border-color:#e53935; color:#c62828;">With ARDS (4 ~ 6 ml/kg)</div>
    <div class="vt-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="vt-item" style="border-color:#ef9a9a;"><span class="vt-label" style="color:#c62828;">Target 4ml</span><span id="vt-4" class="vt-val" style="color:#b71c1c;">0</span></div>
        <div class="vt-item" style="border-color:#ef9a9a;"><span class="vt-label" style="color:#c62828;">Target 6ml</span><span id="vt-6-ards" class="vt-val" style="color:#b71c1c;">0</span></div>
    </div>
    <button class="btn-vent-print" onclick="window.print()">ğŸ–¨ï¸ ê²°ê³¼ ì¶œë ¥ (Print)</button>
    <button class="btn-popup-close" onclick="closeAllPopups()">ë‹«ê¸°</button>
</div>

<div id="yale-panel" class="popup-panel" style="max-width: 620px; width:95%; padding:0; height:90vh; overflow:auto;">
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

    /* âœ… ì „ì—­(:root, body) â†’ #yale-panel ë‚´ë¶€ë¡œ ìŠ¤ì½”í”„ ì œí•œ */
    #yale-panel {
      --yale-blue: #154360;
      --yale-accent: #2980b9;
      --footer-bg: #2c3e50;
      background: transparent;
    }

    /* ì›ë˜ bodyì— ìˆë˜ ìŠ¤íƒ€ì¼ì„ yale-panel ë‚´ë¶€ ë˜í¼ì— ì ìš© */
    #yale-panel .yale-body {
      font-family: 'Pretendard', sans-serif;
      background-color: #e5e8e8;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      box-sizing: border-box;
    }

    #yale-panel .container {
      width: 100%;
      max-width: 550px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #yale-panel .header {
      background: linear-gradient(135deg, var(--yale-blue) 0%, #21618c 100%);
      color: white;
      padding: 25px;
      text-align: center;
      border-bottom: 4px solid #aab7b8;
    }

    #yale-panel .header h1 { margin: 0; font-size: 1.5rem; letter-spacing: 0.5px; }
    #yale-panel .header p { margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.8; }

    #yale-panel .target-range {
      margin-top: 8px;
      font-size: 1rem;
      color: #ffcdce;
      font-weight: 800;
      display: inline-block;
      padding: 2px 12px;
      border-radius: 20px;
      background: rgba(0,0,0,0.1);
    }

    #yale-panel .content { padding: 25px 20px 10px 20px; }

    #yale-panel .section {
      background: #f8f9f9;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #d5dbdb;
    }

    #yale-panel h2 {
      font-size: 1.05rem;
      color: var(--yale-blue);
      margin: 0 0 15px 0;
      border-left: 4px solid var(--yale-accent);
      padding-left: 10px;
      font-weight: 700;
    }

    #yale-panel label {
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #2c3e50;
    }

    #yale-panel input {
      width: 100%;
      padding: 12px;
      border: 1px solid #bdc3c7;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      margin-bottom: 12px;
    }

    #yale-panel button {
      width: 100%;
      padding: 15px;
      background: var(--yale-blue);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    #yale-panel button:hover { background: var(--yale-accent); }

    #yale-panel .result-box {
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      display: none;
      line-height: 1.6;
      font-size: 0.95rem;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: yaleFadeInUp 0.4s ease-out;
    }

    @keyframes yaleFadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #yale-panel .res-success { background: linear-gradient(135deg, #27ae60, #16a085); }
    #yale-panel .res-warning { background: linear-gradient(135deg, #f39c12, #d35400); }
    #yale-panel .res-danger  { background: linear-gradient(135deg, #e74c3c, #c0392b); }

    #yale-panel .bold { font-weight: 900; text-decoration: underline; font-size: 1.1rem; }

    #yale-panel .footer {
      background: var(--footer-bg);
      color: #ecf0f1;
      padding: 25px 20px;
      text-align: center;
      border-top: 4px solid #f39c12;
    }

    #yale-panel .version-badge {
      display: inline-block;
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      color: #f39c12;
      font-weight: bold;
      margin-bottom: 10px;
    }

    #yale-panel .copyright-text { font-size: 0.8rem; color: #bdc3c7; margin-bottom: 10px; }
    #yale-panel .legal-note {
      font-size: 0.7rem;
      color: #7f8c8d;
      line-height: 1.5;
      text-align: justify;
      text-align-last: center;
    }

    #yale-panel .small-inst { font-size: 0.85em; opacity: 0.95; line-height: 1.4; display: block; margin: 4px 0; }

    /* íŒì—… ë‹«ê¸° ë²„íŠ¼(ê¸°ì¡´ ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ê³¼ ê³µì¡´) */
    #yale-panel .yale-close-wrap { padding: 0 20px 20px; }
    #yale-panel .yale-close-btn { background:#34495e; }
    #yale-panel .yale-close-btn:hover { background:#2c3e50; }
  </style>

  <div class="yale-body">
    <div class="container">
      <div class="header">
        <h1>YALE INSULIN INFUSION PROTOCOL</h1>
        <p>Concentration: 100 units / 100 mL (1:1)</p>
        <div class="target-range">Target BST: 140 - 180 mg/dL</div>
      </div>

      <div class="content">
        <div class="section">
          <h2>1. ì´ˆê¸° ì‹œì‘ (Initiation)</h2>
          <label>í˜„ì¬ BST (mg/dL)</label>
          <input type="number" id="initBST" placeholder="ìˆ˜ì¹˜ ì…ë ¥ (181 ì´ìƒ)" onkeydown="if(event.key === 'Enter'){calcStart()}">
          <button onclick="calcStart()">ì´ˆê¸° íˆ¬ì—¬ëŸ‰ ê³„ì‚°</button>
          <div id="startRes" class="result-box"></div>
        </div>

        <div class="section">
          <h2>2. ì¡°ì ˆ ë° ëŒ€ì²˜ (Maintenance)</h2>
          <label>í˜„ì¬ ì£¼ì… ì†ë„ (cc/hr)</label>
          <input type="number" id="curRate" step="0.1" placeholder="í˜„ì¬ cc/hr">
          <div style="display: flex; gap: 10px;">
            <div style="flex:1;"><label>ì´ì „ BST</label><input type="number" id="prevBST"></div>
            <div style="flex:1;"><label>í˜„ì¬ BST</label><input type="number" id="currBST" onkeydown="if(event.key === 'Enter'){calcAdjust()}"></div>
          </div>
          <label>ì¸¡ì • ê°„ê²© (ì‹œê°„)</label>
          <input type="number" id="interval" value="1">
          <button onclick="calcAdjust()" style="background: #34495e;">ë¶„ì„ ë° ì†ë„ì¡°ì •</button>
          <div id="adjRes" class="result-box"></div>
          <div style="color: black; font-size: 0.8rem; font-weight: normal; margin-top: 8px; text-align: left; padding-left: 5px;">
            * Target BST 3íšŒ ì—°ì† ë„ë‹¬ ì‹œ ì¸¡ì •ê°„ê²© q 1h â†’ q 2h ë³€ê²½
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="version-badge">Version 1.4</div>
        <div class="copyright-text">Copyright Â© 2026 SCHC ICU 'TEAM PACEMAKER'. All rights reserved.</div>

        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">

        <div class="legal-note">
          ë³¸ í”„ë¡œê·¸ë¨ì€ ê°„í˜¸ ì—…ë¬´ ë³´ì¡° ë„êµ¬ì…ë‹ˆë‹¤. ê³„ì‚° ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, í™˜ìì˜ ê°œë³„ì ì¸ ì„ìƒ ìƒíƒœì™€ ì£¼ì¹˜ì˜ ì²˜ë°©ì´ ìš°ì„ í•©ë‹ˆë‹¤. ìµœì¢… íˆ¬ì•½ í™•ì¸ ë° ê²°ì •ì— ëŒ€í•œ ì±…ì„ì€ ì‚¬ìš©ì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.
        </div>

        <div style="margin-bottom: 12px;">
          <a href="https://doi.org/10.1177/10600280221074683" target="_blank"
             style="color: #7f8c8d; font-size: 0.7rem; text-decoration: none; opacity: 0.8;">
            Reference: 10.1177/10600280221074683
          </a>
        </div>

        <div class="yale-close-wrap">
          <button class="yale-close-btn" onclick="closeAllPopups()">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function calcStart() {
      const bst = parseFloat(document.getElementById('initBST').value);
      const res = document.getElementById('startRes');
      if(!bst) { alert("BST ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

      if(bst <= 180) {
        res.style.display = "block";
        res.className = "result-box res-warning";
        res.innerHTML = "BST 180 ì´í•˜ëŠ” í”„ë¡œí† ì½œ ì‹œì‘ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤.";
        return;
      }

      const rate = (Math.round((bst / 100) * 2) / 2).toFixed(1);
      let bolusText = "Bolus ì—†ìŒ";

      if (bst >= 300) {
        const bolus = Math.round(bst / 100);
        const maxBolus = Math.min(bolus, 14);
        bolusText = `RI <span class="bold">${maxBolus} units</span> IV Bolus íˆ¬ì—¬`;
      }

      res.style.display = "block";
      res.className = "result-box res-success";
      res.innerHTML = `â” <b>${bolusText}</b><br>â” ì£¼ì… ì†ë„: <b><span class="bold">${rate} cc/hr</span></b>`;
    }

    function calcAdjust() {
      const rate = parseFloat(document.getElementById('curRate').value);
      const prev = parseFloat(document.getElementById('prevBST').value);
      const curr = parseFloat(document.getElementById('currBST').value);
      const time = parseFloat(document.getElementById('interval').value);
      const res = document.getElementById('adjRes');

      if(isNaN(rate) || isNaN(prev) || isNaN(curr)) {
        alert("ëª¨ë“  ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const change = (prev - curr) / time;

      let delta;
      if (rate < 3) delta = 0.5;
      else if (rate <= 6) delta = 1.0;
      else if (rate <= 9.5) delta = 1.5;
      else if (rate <= 14.5) delta = 2.0;
      else if (rate <= 19.5) delta = 3.0;
      else if (rate <= 24.5) delta = 4.0;
      else delta = 5.0;

      res.style.display = "block";
      res.className = "result-box";

      if (curr < 50) {
        res.classList.add("res-danger");
        res.innerHTML = `ğŸš¨ <b>ì£¼ì… ì¦‰ì‹œ ì¤‘ë‹¨ ë° 50% DW 25g IV íˆ¬ì—¬</b><br>
        <span class="small-inst">
          1. 15ë¶„ ê°„ê²© BST í™•ì¸ ë° 70 ë¯¸ë§Œ ì‹œ 50% DW 25g IV ì¬íˆ¬ì—¬<br>
          2. BST 100â†‘ í™•ì¸ ì‹œ 1ì‹œê°„ ë’¤ BST ì¬í™•ì¸
        </span>
        â” 1ì‹œê°„ ë’¤ BST 100â†‘ ì´ë©´ <b>${(rate * 0.5).toFixed(1)} cc/hr</b> ì¬ê°œ`;
      } else if (curr < 70) {
        res.classList.add("res-warning");
        res.innerHTML = `âš ï¸ <b>ì£¼ì… ì¦‰ì‹œ ì¤‘ë‹¨ ë° 50% DW 12.5g IV íˆ¬ì—¬</b><br>
        <span class="small-inst">
          1. 15ë¶„ ê°„ê²© BST í™•ì¸ ë° 70 ë¯¸ë§Œ ì‹œ 50% DW 12.5g IV ì¬íˆ¬ì—¬<br>
          2. BST 100â†‘ í™•ì¸ ì‹œ 1ì‹œê°„ ë’¤ BST ì¬í™•ì¸
        </span>
        â” 1ì‹œê°„ ë’¤ BST 100â†‘ ì´ë©´ <b>${(rate * 0.75).toFixed(1)} cc/hr</b> ì¬ê°œ`;
      } else if (curr < 100) {
        res.classList.add("res-warning");
        res.innerHTML = `âš ï¸ <b>ì£¼ì… ì¦‰ì‹œ ì¤‘ë‹¨</b><br>
        <span class="small-inst">
          1. 30ë¶„ ê°„ê²© BST í™•ì¸ ë° 70 ë¯¸ë§Œ ì‹œ 50% DW 12.5g IV íˆ¬ì—¬<br>
          2. BST 100â†‘ í™•ì¸ ì‹œ <b>${(rate * 0.75).toFixed(1)} cc/hr</b> ì¬ê°œ
        </span>`;
      } else {
        let nextRate = rate;
        let isHold = false;

        if (curr >= 250) {
          if (change < 0) nextRate = rate + 2 * delta;
          else if (change <= 40) nextRate = rate + delta;
          else if (change <= 80) nextRate = rate;
          else if (change <= 120) nextRate = rate - delta;
          else { nextRate = rate - 2 * delta; isHold = true; }
        } else if (curr >= 180) {
          if (change <= -40) nextRate = rate + 2 * delta;
          else if (change <= 0) nextRate = rate + delta;
          else if (change <= 40) nextRate = rate;
          else if (change <= 80) nextRate = rate - delta;
          else { nextRate = rate - 2 * delta; isHold = true; }
        } else if (curr >= 140) {
          if (change <= -21) nextRate = rate + delta;
          else if (change <= 20) nextRate = rate;
          else if (change <= 40) nextRate = rate - delta;
          else { nextRate = rate - 2 * delta; isHold = true; }
        } else {
          if (change < 0) nextRate = rate;
          else if (change <= 20) nextRate = rate - delta;
          else { nextRate = rate - 2 * delta; isHold = true; }
        }

        if (nextRate < 0) nextRate = 0;
        res.classList.add(isHold ? "res-warning" : "res-success");
        res.innerHTML = `ë³€í™”ëŸ‰: ${change.toFixed(1)} mg/dL/hr<br>${isHold ? "â— <b>30ë¶„ HOLD í›„ ì¬ê°œ</b><br>" : ""}ğŸ‘‰ ë‹¤ìŒ ì†ë„: <b><span class="bold">${nextRate.toFixed(1)} cc/hr</span></b>`;
      }
    }
  </script>
</div>


<div id="hep-panel" class="popup-panel">
    <h3 style="text-align:center; margin-top:0; color:#e65100; margin-bottom:5px;">ğŸ©¸ Heparin Protocol</h3>
    <div style="text-align:center; font-size:0.85rem; color:#666; margin-bottom:15px;">
        Standard Mix: <strong>25,000 U / 250 cc</strong> (100 U/cc)
    </div>

    <div class="hep-protocol-box">
        <div class="hep-protocol-title">Heparinization for ACS / MI<br><span style="font-size:0.8em; font-weight:500;">(Bolus 60U/kg, Rate 12U/kg/hr)</span></div>
        <div style="padding:10px; background:#fff; text-align:center;">
            <span style="font-size:0.9rem; color:#e65100; display:block;">Initial Bolus (60U/kg)</span>
            <span id="hep-acs-bolus" style="font-size:1.5rem; font-weight:900; color:#bf360c;">0</span> Unit
        </div>
        <div class="hep-calc-row">
            <span class="hep-calc-label">U/kg/hr</span>
            <input type="number" id="hep-acs-u-input" class="hep-calc-input" placeholder="12" oninput="calcHeparin()" step="0.01">
            <span style="font-weight:900;">âœ</span>
            <div class="hep-calc-result"><span id="hep-acs-cc-result">0.0</span> <span style="font-size:0.7em;">cc/hr</span></div>
        </div>
        <div class="hep-calc-row">
            <span class="hep-calc-label">cc/hr</span>
            <input type="number" id="hep-acs-cc-input" class="hep-calc-input" placeholder="0" oninput="calcHeparin()" step="0.01">
            <span style="font-weight:900;">âœ</span>
            <div class="hep-calc-result"><span id="hep-acs-u-result">0.0</span> <span style="font-size:0.7em;">U/kg</span></div>
        </div>
    </div>

    <div class="hep-protocol-box" style="border-color:#ffab91;">
        <div class="hep-protocol-title" style="background:#ffccbc; color:#d84315;">Heparinization for PTE / DVT<br><span style="font-size:0.8em; font-weight:500;">(Bolus 80U/kg, Rate 18U/kg/hr)</span></div>
        <div style="padding:10px; background:#fff; text-align:center;">
            <span style="font-size:0.9rem; color:#d84315; display:block;">Initial Bolus (80U/kg)</span>
            <span id="hep-pte-bolus" style="font-size:1.5rem; font-weight:900; color:#bf360c;">0</span> Unit
        </div>
        <div class="hep-calc-row">
            <span class="hep-calc-label">U/kg/hr</span>
            <input type="number" id="hep-pte-u-input" class="hep-calc-input" placeholder="18" oninput="calcHeparin()" step="0.01">
            <span style="font-weight:900;">âœ</span>
            <div class="hep-calc-result"><span id="hep-pte-cc-result">0.0</span> <span style="font-size:0.7em;">cc/hr</span></div>
        </div>
        <div class="hep-calc-row">
            <span class="hep-calc-label">cc/hr</span>
            <input type="number" id="hep-pte-cc-input" class="hep-calc-input" placeholder="0" oninput="calcHeparin()" step="0.01">
            <span style="font-weight:900;">âœ</span>
            <div class="hep-calc-result"><span id="hep-pte-u-result">0.0</span> <span style="font-size:0.7em;">U/kg</span></div>
        </div>
    </div>

    <div class="hep-section-header" style="margin-top:20px; border-left-color:#d32f2f; background:#ffebee; color:#b71c1c;">aPTT Adjustment (Nomogram)</div>
    <div class="hep-input-row">
        <span style="font-weight:700; color:#bf360c;">í˜„ì¬ ì†ë„:</span>
        <input type="number" id="hep-curr-rate" class="hep-input" placeholder="0" oninput="calcHeparinAdjustment()" step="0.01">
        <span style="font-weight:700;">cc/hr</span>
    </div>
    <div class="hep-input-row">
        <span style="font-weight:700; color:#bf360c;">aPTT ê²°ê³¼:</span>
        <select id="hep-aptt" class="hep-select" onchange="calcHeparinAdjustment()">
            <option value="none">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="<35">&lt; 35 (sec)</option>
            <option value="35-45">35 - 45 (sec)</option>
            <option value="46-70">46 - 70 (sec) [Target]</option>
            <option value="71-90">71 - 90 (sec)</option>
            <option value=">90">&gt; 90 (sec)</option>
        </select>
    </div>
    <div class="hep-action-box">
        <div style="margin-bottom:8px;">
            <span style="color:#bf360c; font-size:0.9rem;">ì¶”ê°€ Bolus ìš©ëŸ‰</span><br>
            <span id="hep-adj-bolus" style="font-size:1.4rem; font-weight:900;">0</span> Unit
        </div>
        <span class="hep-action-text" id="hep-action-msg">ì¡°ì ˆ í›„ ì†ë„ (New Rate)</span>
        <span id="hep-adj-rate" class="hep-new-rate">0.0</span>
        <span style="font-weight:700; color:#d84315;">cc/hr</span>
    </div>
    <button class="btn-popup-close" onclick="closeAllPopups()">ë‹«ê¸°</button>
</div>

<div id="selection-panel" class="popup-panel">
    <h3 style="text-align:center; margin-top:0;">ì•½ë¬¼ ëª©ë¡ ì„ íƒ</h3>
    <div class="bulk-btn-row">
        <button class="btn-bulk" onclick="toggleCheckboxes(true)">ì „ì²´ ì„ íƒ</button>
        <button class="btn-bulk" onclick="toggleCheckboxes(false)">ì „ì²´ í•´ì œ</button>
    </div>
    <div id="checklist-container"></div>
    <button class="btn-confirm-final" onclick="closeAllPopups()" style="background-color: #0055b8 !important; color: #ffffff !important;">âœ… ì„ íƒ ì™„ë£Œ (í™•ì¸)</button>
    <button class="btn-reset-final" onclick="resetAllData()">âš ï¸ ë°ì´í„° ì´ˆê¸°í™” (ëª¨ë“  ì„¤ì • ë¦¬ì…‹)</button>
</div>

<div id="info-panel" class="popup-panel">
    <div id="info-title" class="info-title">ì•½ë¬¼ ì •ë³´</div>
    <div id="info-content" class="info-content"></div>
    <button class="btn-popup-close" onclick="closeAllPopups()">ë‹«ê¸°</button>
</div>

<script>
    let currentMode = 0; 
    let currentDept = localStorage.getItem('sch_icu_dept') || 'CCU'; 

    const drugs = [
        { id: 'norepi', name: 'Norepinephrine', sub: '(4mg/4ml/1amp)<br>(20mg/20ml/1amp)', amt: 20, vol: 200, unit: 'mcg/kg/min', type: 1, color: 'red', uTxt: 'txt-standard', info: "* Maintenance: 0.01~0.3 mcg/kg/min (Max 0.5)\n* Standard mix: 20mg + D5W 200ml" },
        { id: 'epi', name: 'Epinephrine', sub: '(1mg/1amp)', amt: 4, vol: 200, unit: 'mcg/kg/min', type: 1, color: 'red', uTxt: 'txt-standard', info: "* Maintenance: 0.01~0.03 mcg/kg/min (ì¦ëŸ‰ ê°€ëŠ¥)\n* Standard mix: 4mg + D5W 200ml" },
        { id: 'vaso', name: 'Vasopressin', sub: '(20IU/1amp)', amt: 20, vol: 100, unit: 'Unit/min', type: 2, color: 'red', uTxt: 'txt-vaso', info: "* Maintenance: 0.01~0.04 unit/min (Max 0.1)\n* Standard mix: 20IU + D5W 100ml" },
        { id: 'dobu', name: 'Dobutamine', sub: '(250mg/1amp)', amt: 500, vol: 250, unit: 'mcg/kg/min', type: 1, color: 'red', uTxt: 'txt-standard', info: "* Maintenance: 1~6 mcg/kg/min (Max 20)\n* Standard mix: 500mg + D5W 250ml" },
        { id: 'dopa', name: 'Dopamine', sub: '(200mg/1amp)', amt: 400, vol: 250, unit: 'mcg/kg/min', type: 1, color: 'red', uTxt: 'txt-standard', info: "* Maintenance: 2~30 mcg/kg/min\n* Standard mix: 400mg + D5W 200ml" },
        
        { id: 'ntg', name: 'Nitroglycerin', sub: '(50mg/50cc/1vial)', amt: 50, vol: 50, unit: 'mcg/kg/min', type: 1, color: 'green', uTxt: 'txt-standard', info: "* Start dose: 5 mcg/min\n* Inc by 5 mcg/min every 3~5min (Max 20)\n* Standard mix: 100mg + D5W 200ml" },
        { id: 'mc_ntg', name: 'MC Nitroglycerin', sub: '(100mg/500cc)', amt: 100, vol: 500, unit: 'mcg/min', type: 5, color: 'green', uTxt: 'txt-mcgmin', info: "* Start dose: 5 mcg/min\n* Inc by 5 mcg/min every 3~5min (Max 20)\n* Standard mix: 100mg + D5W 200ml" },
        { id: 'esmolol', name: 'Esmolol', sub: '(100mg/10ml/1vial)', amt: 2000, vol: 500, unit: 'mcg/kg/min', type: 1, color: 'green', uTxt: 'txt-standard', info: "* Range: 50 ~ 200 mcg/kg/min\n* Standard mix: 2000mg + NS 500ml" },
        { id: 'nicar', name: 'Nicardipine', sub: '(10mg/10ml/1amp)', amt: 100, vol: 200, unit: 'mcg/kg/min', type: 1, color: 'green', uTxt: 'txt-standard', info: "* Range: 0.5 ~ 6 mcg/kg/min\n* Standard mix: 100mg + NS 200ml" },
        { id: 'diltia', name: 'Diltiazem', sub: '(50mg/1vial)', amt: 100, vol: 100, unit: 'mg/hr', type: 6, color: 'green', uTxt: 'txt-mghr', info: "* Range: 5 ~ 15 mg/hr\n* Standard mix: 100mg + NS 100ml" },
        { id: 'iso', name: 'Isoproterenol', sub: '(0.2mg/1ml/1amp)', amt: 1, vol: 100, unit: 'mcg/min', type: 5, color: 'green', uTxt: 'txt-mcgmin', info: "* Maintenance: 0.5~5 mcg/min (Max 20)\n* Standard mix: 1mg + NS/5DW 100ml" },
        { id: 'milri', name: 'Milrinone', sub: '(10mg/10ml/1amp)', amt: 20, vol: 100, unit: 'mcg/kg/min', type: 1, color: 'green', uTxt: 'txt-standard', info: "* Loading: 50mcg/kg (10min)\n* Maintenance: 0.375~0.75 mcg/kg/min" },

        { id: 'remi', name: 'Remifentanil', sub: '(5mg/1vial)', amt: 10, vol: 100, unit: 'mcg/kg/min', type: 1, color: 'blue', uTxt: 'txt-standard', info: "* Maintenance: 0.025~0.2 mcg/kg/min\n* Standard mix: 10mg + D5W 100ml" },
        { id: 'propo', name: 'Propofol', sub: '(1000mg/50cc/1bt)', amt: 1000, vol: 50, unit: 'mg/kg/hr', type: 3, color: 'blue', uTxt: 'txt-mghr', info: "* Loading: 0.5~1 mg/kg\n* Maintenance: 0.1~2 mg/kg/hr (Max 4)\n* Standard mix: Premix" },
        { id: 'precedex', name: 'Dexmedetomidine', sub: '(1000mcg/250ml/1bt)', amt: 1000, vol: 250, unit: 'mcg/kg/hr', type: 7, color: 'blue', uTxt: 'txt-mcghr', info: "* Maintenance: 0.1~0.6 mcg/kg/hr (Max 0.7)\n* Standard mix: 200mcg + NS 50ml (NS premix)" },
        { id: 'vecu', name: 'Vecuronium', sub: '(10mg/1vial)', amt: 50, vol: 50, unit: 'mcg/kg/min', type: 1, color: 'blue', uTxt: 'txt-standard', info: "* Loading: 0.05~0.1 mg/kg\n* Maintenance: 0.8~1.2 mcg/kg/min\n* Standard mix: 50mg + D5W 50ml" },
        { id: 'rocu', name: 'Rocuronium', sub: '(50mg/5ml/1vial)', amt: 1000, vol: 250, unit: 'mg/kg/hr', type: 3, color: 'blue', uTxt: 'txt-mghr', info: "* Range: 0.2 ~ 0.7 mg/kg/hr\n* Standard mix: 1000mg + NS 250ml" },
        { id: 'mida', name: 'Midazolam', sub: '(15mg/3cc, 5mg/5cc, 3mg/3cc)', amt: 100, vol: 100, unit: 'mg/kg/hr', type: 3, color: 'blue', uTxt: 'txt-mghr', info: "* Maintenance: 0.01~0.1 mg/kg/hr (Max 0.2)\n* IV bolus: 0.02~0.08 mg/kg\n* Standard mix: 100mg + D5W 100ml" },
        { id: 'keta', name: 'Ketamine', sub: '(500mg/10ml/1vial)', amt: 500, vol: 200, unit: 'mcg/kg/min', type: 1, color: 'blue', uTxt: 'txt-standard', info: "* Loading: 0.5~1 mg/kg (1ë¶„ ì´ìƒ)\n* Maintenance: 1~10 mcg/kg/min (Max 20)\n* Standard mix: 500mg + D5W 200ml" },
        { id: 'morphine', name: 'Morphine', sub: '(10mg/1ml/1amp)<br>(15mg/1ml/1amp)', amt: 100, vol: 100, unit: 'mg/hr', type: 6, color: 'blue', uTxt: 'txt-mghr', info: "* Maintenance: 0.5~5 mg/hr (Max 35)\n* Standard mix: 100mg + D5W 100ml" },
        { id: 'hydro', name: 'Hydromorphone', sub: '(2mg/1ml/1amp)', amt: 20, vol: 100, unit: 'mg/hr', type: 6, color: 'blue', uTxt: 'txt-mghr', info: "* Maintenance: 0.25~4 mg/hr\n* Standard mix: 20mg + NS 100ml" },
        { id: 'sufen', name: 'Sufentanil citrate', sub: '(250mcg/5ml/1amp)<br>(50mcg/1ml/1amp)', amt: 250, vol: 50, unit: 'mcg/kg/hr', type: 7, color: 'blue', uTxt: 'txt-mcghr', info: "* Standard mix: 250mcg + NS 50ml\n* Dose unit: mcg/kg/hr" },
        { id: 'fenta', name: 'Fentanyl', sub: '(1000mcg/20ml/1amp)', amt: 2000, vol: 50, unit: 'mcg/kg/hr', type: 7, color: 'blue', uTxt: 'txt-mcghr', info: "* Standard mix: 2000mcg + D5W 50ml\n* Dose unit: mcg/kg/hr" },
        { id: 'freecalc', name: 'ììœ ê³„ì‚°', sub: '(ì‚¬ìš©ì ì„¤ì •)', amt: 100, vol: 100, unit: 'mg/hr', type: 6, color: 'yellow', uTxt: 'txt-mghr', info: "* ììœ ë¡­ê²Œ ë†ë„ì™€ ìš©ëŸ‰ì„ ì„¤ì •í•˜ì—¬ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." }
    ];

    const ccuMix = {
        'norepi': { amt: 4, vol: 50 },
        'epi': { amt: 4, vol: 50 },
        'dobu': { amt: 250, vol: 50 },
        'dopa': { amt: 200, vol: 50 }
    };
    const ccuExclude = ['esmolol', 'nicar', 'diltia', 'iso', 'milri', 'rocu', 'hydro', 'fenta'];
    const sicuExclude = ['esmolol', 'rocu', 'hydro', 'fenta', 'diltia', 'iso'];

    let savedInputs = JSON.parse(localStorage.getItem('sch_icu_inputs')) || {};
    let savedMix = JSON.parse(localStorage.getItem('sch_icu_mix')) || {};
    let activeDrugs = JSON.parse(localStorage.getItem('sch_icu_v73_active'));
    if (!activeDrugs) activeDrugs = drugs.map(d => d.id);

    drugs.forEach(d => { if(!savedInputs[d.id]) savedInputs[d.id] = {0: '', 1: ''}; });

    const tableBody = document.getElementById('tableBody');
    const checklistContainer = document.getElementById('checklist-container');
    const thInput = document.getElementById('th-input');
    const thOutput = document.getElementById('th-output');
    const btnMode0 = document.getElementById('btnMode0');
    const btnMode1 = document.getElementById('btnMode1');

    function init() {
        setDept(currentDept, false); 
        const savedBw = localStorage.getItem('sch_icu_weight');
        if(savedBw) document.getElementById('bw').value = savedBw;
        renderChecklist();
        renderTable();
        if(localStorage.getItem('sch_icu_darkmode') === 'true') {
            document.body.classList.add('dark-mode');
            document.querySelector('.btn-darkmode').innerText = 'â˜€ï¸';
        }
    }

    function saveWeight() { localStorage.setItem('sch_icu_weight', document.getElementById('bw').value); }
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.querySelector('.btn-darkmode').innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        localStorage.setItem('sch_icu_darkmode', isDark);
    }

    function setMode(mode) {
        currentMode = mode;
        if (mode === 0) {
            btnMode0.className = 'mode-btn active'; btnMode1.className = 'mode-btn';
            thInput.innerText = "ì²˜ë°©"; thOutput.innerText = "ì†ë„";
        } else {
            btnMode0.className = 'mode-btn'; btnMode1.className = 'mode-btn active';
            thInput.innerText = "ì†ë„"; thOutput.innerText = "ì²˜ë°©";
        }
        renderTable();
    }

    function setDept(dept, forceReset = true) {
        currentDept = dept;
        localStorage.setItem('sch_icu_dept', dept);
        document.querySelectorAll('.dept-btn').forEach(btn => btn.className = 'dept-btn');
        
        let targetId = '';
        if(dept === 'SICU') targetId = 'btn-sicu';
        if(dept === 'CCU') targetId = 'btn-ccu';
        if(dept === 'MICU') targetId = 'btn-micu';
        
        if(targetId) document.getElementById(targetId).className = 'dept-btn active';

        if (forceReset) {
            // Reset special mix for CCU/SICU drugs
            ['norepi', 'epi', 'dobu', 'dopa'].forEach(id => { if (savedMix[id]) delete savedMix[id]; });
            localStorage.setItem('sch_icu_mix', JSON.stringify(savedMix));
            renderTable();
        }
    }

    function renderTable() {
        tableBody.innerHTML = '';
        let count = 0;
        drugs.forEach(d => {
            // Exclusion Logic
            if (currentDept === 'CCU' && ccuExclude.includes(d.id)) return;
            if (currentDept === 'SICU' && sicuExclude.includes(d.id)) return;
            
            if (!activeDrugs.includes(d.id)) return;
            count++;
            const row = document.createElement('tr');
            row.className = `theme-${d.color}`;
            
            let val = savedInputs[d.id][currentMode];
            let currentAmt = d.amt;
            let currentVol = d.vol;

            // Apply Mix Rule
            if (currentDept === 'CCU' && ccuMix[d.id]) {
                currentAmt = ccuMix[d.id].amt;
                currentVol = ccuMix[d.id].vol;
            }
            // User Override
            if (savedMix[d.id]) {
                currentAmt = savedMix[d.id].amt;
                currentVol = savedMix[d.id].vol;
            }

            let doseUnit = d.unit.replace('Unit','U'); 
            let inputUnit = currentMode === 0 ? doseUnit : "cc/hr";
            let outputUnit = currentMode === 0 ? "cc/hr" : doseUnit;
            let amtUnit = 'mg'; if(d.id === 'vaso') amtUnit = 'IU'; if(d.id === 'precedex' || d.id === 'sufen' || d.id === 'fenta' || d.id === 'iso') amtUnit = 'mcg';
            let unitCell = '';
            if (d.id === 'freecalc') {
                unitCell = '<td class="td-unit ' + d.uTxt + '"><select id="unit_freecalc" onchange="changeUnit(\'freecalc\')" style="width:100%; padding:5px; font-size:0.75rem; font-weight:800; text-align:center; background:transparent; border:none; color:inherit;">';
                const units = [
                    {v:'mcg/kg/min', t:1, l:'mcg/kg/min'},
                    {v:'Unit/min', t:2, l:'U/min'},
                    {v:'mg/kg/hr', t:3, l:'mg/kg/hr'},
                    {v:'mcg/min', t:5, l:'mcg/min'},
                    {v:'mg/hr', t:6, l:'mg/hr'},
                    {v:'mcg/kg/hr', t:7, l:'mcg/kg/hr'}
                ];
                units.forEach(u => {
                    const sel = d.unit === u.v ? ' selected' : '';
                    unitCell += '<option value="' + u.v + '" data-type="' + u.t + '"' + sel + '>' + u.l + '</option>';
                });
                unitCell += '</select></td>';
            } else {
                unitCell = '<td class="td-unit ' + d.uTxt + '">' + inputUnit + '</td>';
            }
            
            row.innerHTML = `
                <td class="td-name" onclick="showInfo('${d.id}')">
                    <div class="drug-cell-container">
                        <div class="copy-btn-area"><span class="copy-icon" onclick="copyMixInfo('${d.id}', '${amtUnit}', event)">â€»</span></div>
                        <div class="name-area">
                            <div class="drug-title-row"><span class="drug-title">${d.name}</span><span class="info-icon">â“˜</span></div>
                            <span class="drug-mix-info">${d.sub}</span>
                        </div>
                    </div>
                </td>
                <td class="td-white"><input type="number" step="5" class="input-mini" id="amt_${d.id}" value="${currentAmt}" oninput="updateMix('${d.id}')"></td>
                <td class="td-white"><input type="number" step="10" class="input-mini" id="vol_${d.id}" value="${currentVol}" oninput="updateMix('${d.id}')"></td>
                <td class="td-input"><input type="number" step="0.01" class="input-dose" id="input_${d.id}" value="${val}" placeholder="0" oninput="handleInput('${d.id}')"></td>
                ${unitCell}
                <td class="td-result"><span id="output_${d.id}" class="res-val">0.00</span><span class="res-unit">${outputUnit}</span></td>
            `;
            tableBody.appendChild(row);
            setTimeout(() => calc(d.id), 0);
        });
        document.getElementById('empty-msg').style.display = count === 0 ? 'block' : 'none';
    }

    let ventGender = 'male';
    function openVentCalc() {
        document.getElementById('vent-panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        calcPBW();
    }
    function setGender(gender) {
        ventGender = gender;
        document.getElementById('btn-male').className = gender === 'male' ? 'gender-btn active' : 'gender-btn';
        document.getElementById('btn-female').className = gender === 'female' ? 'gender-btn active' : 'gender-btn';
        calcPBW();
    }
    function calcPBW() {
        const height = parseFloat(document.getElementById('vent-height').value) || 0;
        let pbw = 0;
        if (height > 0) {
            if (ventGender === 'male') pbw = 50 + 0.91 * (height - 152.4);
            else pbw = 45.5 + 0.91 * (height - 152.4);
        }
        document.getElementById('pbw-val').innerText = pbw.toFixed(1);
        document.getElementById('vt-6').innerText = Math.round(pbw * 6);
        document.getElementById('vt-8').innerText = Math.round(pbw * 8);
        document.getElementById('vt-4').innerText = Math.round(pbw * 4);
        document.getElementById('vt-6-ards').innerText = Math.round(pbw * 6);
    }

    function openYaleScale() {
        document.getElementById('yale-panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function openHeparinCalc() {
        document.getElementById('hep-panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        calcHeparin();
        calcHeparinAdjustment();
    }
    
    function calcHeparin() {
        const weight = parseFloat(document.getElementById('bw').value) || 0;
        document.getElementById('hep-acs-bolus').innerText = weight * 60;
        document.getElementById('hep-pte-bolus').innerText = weight * 80;

        const inputU_ACS = parseFloat(document.getElementById('hep-acs-u-input').value);
        if (!isNaN(inputU_ACS)) document.getElementById('hep-acs-cc-result').innerText = ((inputU_ACS * weight) / 100).toFixed(1);
        else document.getElementById('hep-acs-cc-result').innerText = "0.0";
        
        const inputCC_ACS = parseFloat(document.getElementById('hep-acs-cc-input').value);
        if (!isNaN(inputCC_ACS)) document.getElementById('hep-acs-u-result').innerText = ((inputCC_ACS * 100) / weight).toFixed(1);
        else document.getElementById('hep-acs-u-result').innerText = "0.0";

        const inputU_PTE = parseFloat(document.getElementById('hep-pte-u-input').value);
        if (!isNaN(inputU_PTE)) document.getElementById('hep-pte-cc-result').innerText = ((inputU_PTE * weight) / 100).toFixed(1);
        else document.getElementById('hep-pte-cc-result').innerText = "0.0";

        const inputCC_PTE = parseFloat(document.getElementById('hep-pte-cc-input').value);
        if (!isNaN(inputCC_PTE)) document.getElementById('hep-pte-u-result').innerText = ((inputCC_PTE * 100) / weight).toFixed(1);
        else document.getElementById('hep-pte-u-result').innerText = "0.0";
    }

    function calcHeparinAdjustment() {
        const weight = parseFloat(document.getElementById('bw').value) || 0;
        const currentRate = parseFloat(document.getElementById('hep-curr-rate').value) || 0;
        const aptt = document.getElementById('hep-aptt').value;
        let bolus = 0; let changeRateU = 0; let msg = "ì†ë„ ì¡°ì ˆ (Adjust Rate)";

        if (aptt === '<35') { bolus = weight * 80; changeRateU = 4; } 
        else if (aptt === '35-45') { bolus = weight * 40; changeRateU = 2; } 
        else if (aptt === '46-70') { bolus = 0; changeRateU = 0; msg = "ìœ ì§€ (No Change)"; } 
        else if (aptt === '71-90') { bolus = 0; changeRateU = -2; } 
        else if (aptt === '>90') { bolus = 0; changeRateU = -3; msg = "1hr Stop & Decrease"; } 
        else {
            document.getElementById('hep-adj-bolus').innerText = "0";
            document.getElementById('hep-adj-rate').innerText = "0.0";
            document.getElementById('hep-action-msg').innerText = "ì¡°ì ˆ í›„ ì†ë„";
            return;
        }
        const changeCC = (weight * changeRateU) / 100;
        let newRate = currentRate + changeCC;
        if(newRate < 0) newRate = 0;

        document.getElementById('hep-adj-bolus').innerText = bolus;
        document.getElementById('hep-adj-rate').innerText = newRate.toFixed(1);
        document.getElementById('hep-action-msg').innerText = msg;
    }


    function updateMix(id) {
        const newAmt = parseFloat(document.getElementById(`amt_${id}`).value);
        const newVol = parseFloat(document.getElementById(`vol_${id}`).value);
        if(!savedMix[id]) savedMix[id] = {};
        savedMix[id].amt = newAmt; savedMix[id].vol = newVol;
        localStorage.setItem('sch_icu_mix', JSON.stringify(savedMix));
        calc(id);
    }

    function handleInput(id) {
        const val = document.getElementById(`input_${id}`).value;
        savedInputs[id][currentMode] = val;
        localStorage.setItem('sch_icu_inputs', JSON.stringify(savedInputs));
        calc(id);
    }

    function calc(id) {
        const drug = drugs.find(d => d.id === id);
        const weight = parseFloat(document.getElementById('bw').value) || 0;
        
        let currentAmt = parseFloat(document.getElementById(`amt_${id}`).value);
        let currentVol = parseFloat(document.getElementById(`vol_${id}`).value);
        if (isNaN(currentAmt)) currentAmt = d.amt;
        if (isNaN(currentVol)) currentVol = d.vol;

        const inputVal = parseFloat(savedInputs[id][currentMode]) || 0;
        const outputEl = document.getElementById(`output_${id}`);

        if (currentAmt === 0 || currentVol === 0) { outputEl.innerText = "Err"; return; }

        let conc = 0;
        if ([1, 4, 5].includes(drug.type)) { conc = (currentAmt * 1000) / currentVol; } 
        else if (drug.type === 2) { conc = currentAmt / currentVol; } 
        else if (drug.type === 3 || drug.type === 6) { conc = currentAmt / currentVol; } 
        else if (drug.type === 7) { conc = currentAmt / currentVol; }

        let result = 0;
        if (currentMode === 0) { 
            if (drug.type === 1) { if (weight > 0) result = (inputVal * weight * 60) / conc; }
            else if (drug.type === 2) { result = (inputVal * 60) / conc; }
            else if (drug.type === 3) { if (weight > 0) result = (inputVal * weight) / conc; } 
            else if (drug.type === 4) { if (weight > 0) result = (inputVal * weight) / conc; }
            else if (drug.type === 5) { result = (inputVal * 60) / conc; }
            else if (drug.type === 6) { result = inputVal / conc; }
            else if (drug.type === 7) { if (weight > 0) result = (inputVal * weight) / conc; } 
        } else { 
            if (drug.type === 1) { if (weight > 0) result = (inputVal * conc) / (weight * 60); }
            else if (drug.type === 2) { result = (inputVal * conc) / 60; }
            else if (drug.type === 3) { if (weight > 0) result = (inputVal * conc) / weight; }
            else if (drug.type === 4) { if (weight > 0) result = (inputVal * conc) / weight; }
            else if (drug.type === 5) { result = (inputVal * conc) / 60; }
            else if (drug.type === 6) { result = inputVal * conc; }
            else if (drug.type === 7) { if (weight > 0) result = (inputVal * conc) / weight; } 
        }
        outputEl.innerText = inputVal === 0 ? "0.00" : result.toFixed(2);
    }

    function calcAll() { activeDrugs.forEach(id => { if(document.getElementById(`input_${id}`)) calc(id); }); }
    
    function changeUnit(id) {
        const select = document.getElementById('unit_' + id);
        const selectedOption = select.options[select.selectedIndex];
        const newUnit = selectedOption.value;
        const newType = parseInt(selectedOption.getAttribute('data-type'));
        const drug = drugs.find(d => d.id === id);
        if (drug) {
            drug.unit = newUnit;
            drug.type = newType;
            calc(id);
            const outputCell = document.querySelector('#output_' + id).parentElement;
            let doseUnit = newUnit.replace('Unit','U');
            let outputUnit = currentMode === 0 ? 'cc/hr' : doseUnit;
            const currentVal = document.getElementById('output_' + id).innerText;
            outputCell.innerHTML = '<span id="output_' + id + '" class="res-val">' + currentVal + '</span><span class="res-unit">' + outputUnit + '</span>';
        }
    }
    function copyMixInfo(id, unit, e) {
        e.stopPropagation(); 
        const drug = drugs.find(d => d.id === id);
        const curAmt = document.getElementById(`amt_${id}`).value;
        const curVol = document.getElementById(`vol_${id}`).value;
        const text = `${drug.name} ${curAmt}${unit} + (   ) ${curVol}cc`;
        navigator.clipboard.writeText(text).then(() => { alert(`[ë¼ë²¨ ë³µì‚¬ ì™„ë£Œ]\n${text}`); });
    }

    function showInfo(id) {
        const drug = drugs.find(d => d.id === id);
        if(!drug) return;
        document.getElementById('info-title').innerText = drug.name;
        document.getElementById('info-content').innerText = drug.info || "ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        document.getElementById('info-panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function toggleCheckboxes(checkStatus) {
        const checkboxes = document.querySelectorAll('#checklist-container input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = checkStatus);
    }

    function closeAllPopups() {
        document.getElementById('selection-panel').style.display = 'none';
        document.getElementById('vent-panel').style.display = 'none';
        document.getElementById('yale-panel').style.display = 'none';
        document.getElementById('hep-panel').style.display = 'none';
        document.getElementById('info-panel').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
        
        const checkboxes = document.querySelectorAll('#checklist-container input');
        if(document.getElementById('selection-panel').style.display === 'block' || checkboxes.length > 0) {
             activeDrugs = [];
             checkboxes.forEach(cb => { if (cb.checked) activeDrugs.push(cb.value); });
             if(activeDrugs.length > 0) localStorage.setItem('sch_icu_v73_active', JSON.stringify(activeDrugs));
             renderTable();

            
        }
    }

    function resetAllData() {
        if(confirm("ëª¨ë“  ì…ë ¥ê°’, Mix ì„¤ì •, ì•½ë¬¼ ëª©ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('sch_icu_inputs');
            localStorage.removeItem('sch_icu_mix');
            localStorage.removeItem('sch_icu_weight');
            localStorage.removeItem('sch_icu_v73_active');
            location.reload();
        }
    }

    function copyEMR() {
        let text = `[ICU Drug Infusion] BW: ${document.getElementById('bw').value}kg\n`;
        let hasData = false;
        drugs.forEach(d => {
            if (currentDept === 'CCU' && ccuExclude.includes(d.id)) return;
            if (currentDept === 'SICU' && sicuExclude.includes(d.id)) return;
            if (!activeDrugs.includes(d.id)) return;
            
            const inputVal = parseFloat(savedInputs[d.id][currentMode]) || 0;
            if (inputVal > 0) {
                hasData = true;
                const outVal = document.getElementById(`output_${d.id}`).innerText;
                let doseUnit = d.unit.replace('Unit','U');
                if (currentMode === 0) text += `- ${d.name}: ${inputVal} ${doseUnit} âœ ${outVal} cc/hr\n`;
                else text += `- ${d.name}: ${inputVal} cc/hr âœ ${outVal} ${doseUnit}\n`;
            }
        });
        if(!hasData) { alert("ì…ë ¥ëœ ì•½ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        navigator.clipboard.writeText(text).then(() => { alert("ğŸ“‹ EMR ê¸°ë¡ìš© í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); });
    }

    function renderChecklist() {
        checklistContainer.innerHTML = '';
        drugs.forEach(d => {
            const checked = activeDrugs.includes(d.id) ? 'checked' : '';
            let colorDot = d.color === 'red' ? 'ğŸ”´' : (d.color === 'blue' ? 'ğŸ”µ' : (d.color === 'yellow' ? 'ğŸŸ¡' : 'ğŸŸ¢'));
            checklistContainer.innerHTML += `<label class="check-item"><input type="checkbox" value="${d.id}" ${checked} style="margin-right:10px; transform:scale(1.3);">${colorDot} ${d.name}</label>`;
        });
    }

    function openSettings() { document.getElementById('selection-panel').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; }
    
    init();
</script>
</body>
</html>







